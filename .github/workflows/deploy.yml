name: Deploy

on:
  push:
    branches:
      - "main"

concurrency:
  group: "production"
  cancel-in-progress: false

permissions:
  id-token: write
  contents: read

env:
  AWS_ACCOUNT: ${{ secrets.AWS_ACCOUNT }}
  AWS_REGION: "us-east-1"
  AWS_ROLE: ${{ secrets.AWS_ROLE }}

jobs:
  build_ui:
    name: 🛠 Build UI assets
    runs-on: ubuntu-latest
    steps:
      - name: 🏗 Check out the repo
        uses: actions/checkout@v3

      - name: 🏗 Setup Yarn and Node
        uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc
          cache: yarn
          cache-dependency-path: ui/yarn.lock

      - name: 🏗 Set Yarn version to Berry
        run: yarn set version berry

      - name: 📚 Install dependencies
        run: |
          yarn install --immutable

      - name: 📚 Generate GraphQL hooks/types
        run: |
          yarn gql

      - name: 🛠 Build UI Assets
        env:
          VITE_SHA: ${{ github.sha }}
        run: |
          yarn build

      - name: 💾 Save UI assets to Github
        uses: actions/upload-artifact@v3
        with:
          name: ui-assets
          path: dist/*
          retention-days: 5

  tf_apply:
    name: 🏗️ Terraform Apply
    runs-on: ubuntu-latest
    outputs:
      ui_s3_bucket: ${{ fromJson(steps.tf_output.outputs.stdout).ui_s3_bucket.value }}
      cloudfront_distribution_id: ${{ fromJson(steps.tf_output.outputs.stdout).cloudfront_distribution_id.value }}
      deployment_url: ${{ fromJson(steps.tf_output.outputs.stdout).deployment_url.value }}
    steps:
      - name: 🏗 Check out the repo
        uses: actions/checkout@v3

      - name: 🔐 Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: 🏗 Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.5.7
          terraform_wrapper: true

      - name: 🏗 Terraform Init
        working-directory: infra
        run: |
          terraform init

      - name: 🪄 Terraform Apply
        working-directory: infra
        run: |
          terraform apply \
            -var="sha=${{ github.sha }}" \
            -auto-approve

      - name: 📝 Save Terraform Output
        id: tf_output
        working-directory: infra
        run: |
          terraform output -json

  deployment:
    name: 🚀 Deploy
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ needs.tf_apply.outputs.deployment_url }}
    needs:
      - build_ui
      - tf_apply
    steps:
      - name: 🏗 Check out the repo
        uses: actions/checkout@v3

      - name: ⬇️ Download UI assets from Github
        uses: actions/download-artifact@v3
        with:
          name: ui-assets
          path: ui-assets

      - name: 🔐 Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE }}
          aws-region: ${{ env.AWS_REGION }}

      - name: 🚀 Upload UI assets to S3
        run: |
          aws s3 sync ui-assets s3://${{ needs.tf_apply.outputs.ui_s3_bucket }} --delete

      - name: 🧹 Invalidate Dev Cloudfront Caches
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ needs.tf_apply.outputs.cloudfront_distribution_id }} \
            --paths '/*'
